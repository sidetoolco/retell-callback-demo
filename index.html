<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sidetool AI Agent Demo</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="shortcut icon" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">
    <style>
      /* Reset and base styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: white;
        min-height: 100vh;
      }

      /* Animations */
      @keyframes slowPulse {
        0%, 100% {
          transform: scale(1);
          opacity: 0.2;
        }
        50% {
          transform: scale(1.3);
          opacity: 0.6;
        }
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      .voice-wave span {
        animation: slowPulse 8s ease-in-out infinite;
      }

      .voice-wave span:nth-child(1) { animation-delay: 0s; }
      .voice-wave span:nth-child(2) { animation-delay: 2s; }
      .voice-wave span:nth-child(3) { animation-delay: 4s; }
      .voice-wave span:nth-child(4) { animation-delay: 1s; }

      /* Layout */
      header {
        border-bottom: 1px solid #e5e7eb;
        padding: 1rem 1.5rem;
      }

      .container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 80px);
        padding: 2rem 1.5rem;
      }

      .content {
        text-align: center;
        max-width: 64rem;
        width: 100%;
      }

      /* Badge */
      .badge {
        display: inline-flex;
        align-items: center;
        background: black;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 2rem;
      }

      .pulse-dot {
        width: 0.5rem;
        height: 0.5rem;
        background: #ef4444;
        border-radius: 9999px;
        margin-right: 0.5rem;
        animation: pulse 2s infinite;
      }

      /* Voice Waves */
      .voice-wave {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 10rem;
        height: 10rem;
        margin: 0 auto 2.5rem;
      }

      .voice-wave span {
        position: absolute;
        border-radius: 9999px;
      }

      .voice-wave span:nth-child(1) {
        width: 8rem;
        height: 8rem;
        background: #d8b4fe;
        opacity: 0.2;
      }

      .voice-wave span:nth-child(2) {
        width: 6rem;
        height: 6rem;
        background: #c084fc;
        opacity: 0.3;
      }

      .voice-wave span:nth-child(3) {
        width: 4rem;
        height: 4rem;
        background: #a855f7;
        opacity: 0.4;
      }

      .voice-wave span:nth-child(4) {
        position: relative;
        width: 3rem;
        height: 3rem;
        background: #9333ea;
      }

      /* Typography */
      h1 {
        font-size: 1.25rem;
        font-weight: bold;
        color: black;
      }

      h2 {
        font-size: 3rem;
        font-weight: bold;
        color: black;
        line-height: 1.2;
        margin-bottom: 1.5rem;
      }

      h2 .subtitle {
        color: #6b7280;
      }

      .description {
        font-size: 1.25rem;
        color: #6b7280;
        max-width: 42rem;
        margin: 0 auto 3rem;
        line-height: 1.6;
      }

      /* Buttons */
      button {
        font-family: inherit;
        cursor: pointer;
        border: none;
        outline: none;
        transition: all 0.2s;
      }

      .btn-primary {
        background: black;
        color: white;
        font-weight: 600;
        padding: 0.75rem 2rem;
        border-radius: 0.5rem;
        font-size: 1.125rem;
      }

      .btn-primary:hover:not(:disabled) {
        background: #374151;
      }

      .btn-primary:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-danger {
        background: #dc2626;
        color: white;
        font-weight: 600;
        padding: 0.75rem 2rem;
        border-radius: 0.5rem;
        font-size: 1.125rem;
      }

      .btn-danger:hover {
        background: #b91c1c;
      }

      /* Status displays */
      .error-box {
        margin-top: 1.5rem;
        background: #fee2e2;
        border: 1px solid #fca5a5;
        color: #991b1b;
        padding: 1rem;
        border-radius: 0.5rem;
        max-width: 42rem;
        margin-left: auto;
        margin-right: auto;
      }

      .success-text {
        color: #059669;
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
      }

      .timer {
        background: #f3f4f6;
        border-radius: 0.5rem;
        padding: 1rem 1.5rem;
        display: inline-block;
        margin-bottom: 1.5rem;
      }

      .timer-display {
        font-size: 1.875rem;
        font-family: 'Courier New', monospace;
        color: #1f2937;
      }

      .hint-text {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 1rem;
      }

      .hidden {
        display: none;
      }

      /* Responsive */
      @media (max-width: 768px) {
        h2 {
          font-size: 2rem;
        }

        .description {
          font-size: 1rem;
        }
      }
    </style>
    <script type="importmap">
      {
        "imports": {
          "retell-client-js-sdk": "https://cdn.jsdelivr.net/npm/retell-client-js-sdk@2.0.7/+esm"
        }
      }
    </script>
  </head>
  <body>
    <!-- Header -->
    <header>
      <img src="logo.svg" alt="Logo" style="height: 28px; width: auto; max-width: 200px; object-fit: contain;">
    </header>

    <!-- Main Content -->
    <div class="container">
      <div class="content">
        <!-- Live Badge -->
        <div class="badge">
          <div class="pulse-dot"></div>
          LIVE: Connecting agents in real time
        </div>

        <!-- Voice Waves -->
        <div class="voice-wave">
          <span></span>
          <span></span>
          <span></span>
          <span></span>
        </div>

        <!-- Status Display -->
        <div id="status-area">
          <h2>
            Flex Logistics
            <br />
            <span class="subtitle">Customer Support Agent</span>
          </h2>

          <p class="description">
            Connect directly with our AI support agent.<br />
            Start a voice conversation right in your browser.
          </p>

          <button id="connect-btn" class="btn-primary" onclick="startCall()">
            Start Voice Call
          </button>

          <div id="error-area" class="error-box hidden"></div>
        </div>

        <!-- Connected State -->
        <div id="connected-area" class="hidden">
          <h2>
            Connected
            <br />
            <span class="subtitle">Flex Support Agent</span>
          </h2>

          <div class="success-text">✅ Voice call active</div>

          <div class="timer">
            <span id="duration" class="timer-display">00:00</span>
          </div>

          <div>
            <button class="btn-danger" onclick="endCall()">
              End Call
            </button>
          </div>

          <p class="hint-text">
            Speak naturally - the AI agent will respond in real-time
          </p>
        </div>
      </div>
    </div>

    <script type="module">
      import { RetellWebClient } from "retell-client-js-sdk";

      // Configuration
      const CONFIG = {
        publicKey: 'key_9b7349002a90326c7c553addd6ce',
        agentId: 'agent_d1e33aa42cae40033f4ce5e641'
      };

      let retellClient = null;
      let callDuration = 0;
      let timerInterval = null;

      // Initialize Retell client
      function initRetellClient() {
        if (!retellClient) {
          retellClient = new RetellWebClient();

          retellClient.on('call_started', () => {
            console.log('✅ Call started');
            showConnectedState();
            startTimer();
          });

          retellClient.on('call_ended', () => {
            console.log('📞 Call ended');
            resetToInitialState();
          });

          retellClient.on('error', (error) => {
            console.error('❌ Call error:', error);
            showError(error.message || 'An error occurred during the call');
            resetToInitialState();
          });

          retellClient.on('agent_start_talking', () => {
            console.log('🎙️ Agent started talking');
          });

          retellClient.on('agent_stop_talking', () => {
            console.log('🔇 Agent stopped talking');
          });

          retellClient.on('update', (update) => {
            console.log('Update:', update);
          });
        }
      }

      // Start call
      window.startCall = async function() {
        try {
          initRetellClient();

          const btn = document.getElementById('connect-btn');
          btn.disabled = true;
          btn.textContent = 'Connecting...';
          hideError();

          console.log('🚀 Creating web call...');

          const response = await fetch('https://api.retellai.com/v2/create-web-call', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${CONFIG.publicKey}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              agent_id: CONFIG.agentId
            })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || `API Error: ${response.status}`);
          }

          const data = await response.json();
          console.log('✅ Web call created:', data.call_id);

          await retellClient.startCall({
            accessToken: data.access_token
          });

          console.log('📞 Call started with access token');

        } catch (error) {
          console.error('❌ Error starting call:', error);
          showError(error.message || 'Failed to start call. Please try again.');
          resetToInitialState();
        }
      };

      // End call
      window.endCall = function() {
        console.log('🔚 Ending call...');
        if (retellClient) {
          retellClient.stopCall();
        }
        resetToInitialState();
      };

      // UI State Management
      function showConnectedState() {
        document.getElementById('status-area').classList.add('hidden');
        document.getElementById('connected-area').classList.remove('hidden');
      }

      function resetToInitialState() {
        document.getElementById('status-area').classList.remove('hidden');
        document.getElementById('connected-area').classList.add('hidden');
        const btn = document.getElementById('connect-btn');
        btn.disabled = false;
        btn.textContent = 'Start Voice Call';
        stopTimer();
      }

      function showError(message) {
        const errorArea = document.getElementById('error-area');
        errorArea.textContent = '⚠️ ' + message;
        errorArea.classList.remove('hidden');
      }

      function hideError() {
        document.getElementById('error-area').classList.add('hidden');
      }

      // Timer functions
      function startTimer() {
        callDuration = 0;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
          callDuration++;
          updateTimerDisplay();
        }, 1000);
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        callDuration = 0;
        updateTimerDisplay();
      }

      function updateTimerDisplay() {
        const minutes = Math.floor(callDuration / 60);
        const seconds = callDuration % 60;
        const display = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        document.getElementById('duration').textContent = display;
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', () => {
        console.log('🎯 Retell Web Call Demo initialized');
        initRetellClient();
      });
    </script>
  </body>
</html>
